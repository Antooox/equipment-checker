<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stegra – NFC Rentals (MVP)</title>

  <!-- Load Supabase UMD (no defer so window.supabase is ready) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    :root { --bg:#0b1020; --fg:#ecf0ff; --muted:#9aa4c7; --card:#121a34; --border:#1f2a4a; --btn:#24409a; --btnb:#3550a7; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:760px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:22px}
    h2{margin:10px 0 0;font-size:18px;color:var(--fg)}
    .muted{color:var(--muted)}
    label{display:block;margin-top:10px;font-size:14px;color:var(--muted)}
    input,button{width:100%;padding:12px;border-radius:12px;border:1px solid #2a385f;background:#0f1630;color:var(--fg);font-size:16px}
    button{cursor:pointer;background:var(--btn);border-color:var(--btnb);margin-top:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .small{font-size:12px;color:#a6b3df;margin-top:6px}
    .hidden{display:none}

    /* List styles */
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .li{display:flex;gap:12px;align-items:center;padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1630}
    .right{margin-left:auto}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block}
    .green{background:#22c55e}
    .red{background:#ef4444}
    .gray{background:#9aa4c7}
    a.itemlink{color:#9ec1ff;text-decoration:none}
    .pill{display:inline-block;padding:5px 10px;border:1px solid #365; border-radius:999px; font-size:12px}
    .back{background:#2b365f;border-color:#3e4c7a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Stegra – NFC Rentals</h1>
      <div id="msg" class="muted">Loading…</div>

      <!-- MAIN LIST (no ?item=) -->
      <div id="listPanel" class="hidden">
        <div class="muted">Tap an item to open its checkout page.</div>
        <div id="list" class="list"></div>
      </div>

      <!-- ITEM PANEL (with ?item=UUID) -->
      <div id="itemPanel" class="hidden">
        <div><span class="pill" id="statusPill">—</span></div>
        <h2 id="itemName">—</h2>
        <div class="small">Renta ID: <span id="itemRenta">—</span></div>

        <div id="startForm">
          <label>Full name</label>
          <input id="fName" placeholder="e.g. Andreas Pettersson" />
          <div class="row">
            <div>
              <label>Phone</label>
              <input id="fPhone" placeholder="070-..." />
            </div>
            <div>
              <label>Company (optional)</label>
              <input id="fCompany" placeholder="Contractor AB" />
            </div>
          </div>
          <label>Expected return (optional)</label>
          <input id="fExpected" type="date" />
          <label>Note (optional)</label>
          <input id="fNote" placeholder="Where used?" />
          <button id="btnStart">Start renting</button>
          <div class="small">Name/phone are cached locally for speed next time.</div>
        </div>

        <div id="returnForm" class="hidden">
          <label>Photo (optional)</label>
          <input id="fPhoto" type="file" accept="image/*" capture="environment" />
          <label>Note (optional)</label>
          <input id="fReturnNote" placeholder="Condition / where left" />
          <button id="btnReturn">Returned</button>
        </div>

        <div id="info" class="small"></div>
        <button id="btnBack" class="back">← Back to list</button>
      </div>
    </div>
  </div>

<script>
  // === Supabase config ===
  const SUPABASE_URL = "https://rvsormwqumgbqhvvfsnw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2c29ybXdxdW1nYnFodnZmc253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTk1OTYsImV4cCI6MjA3NjU3NTU5Nn0.cfn9Y_M2u5D-lXFBDWLuDAMJ4P92whTFgjo8hLj-w-0";
  const RETURNS_BUCKET = "returns";

  let sb = null;
  function ensureSupabaseReady(next){
    if (window.supabase) {
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      next();
    } else {
      setTimeout(()=>ensureSupabaseReady(next), 50);
    }
  }

  const qs = s => document.querySelector(s);
  const p = new URLSearchParams(location.search);
  const ITEM_ID = p.get("item");

  const el = {
    msg: qs("#msg"),
    listPanel: qs("#listPanel"),
    list: qs("#list"),
    itemPanel: qs("#itemPanel"),
    statusPill: qs("#statusPill"),
    itemName: qs("#itemName"),
    itemRenta: qs("#itemRenta"),
    startForm: qs("#startForm"),
    returnForm: qs("#returnForm"),
    info: qs("#info"),
    btnBack: qs("#btnBack"),
    fName: qs("#fName"),
    fPhone: qs("#fPhone"),
    fCompany: qs("#fCompany"),
    fExpected: qs("#fExpected"),
    fNote: qs("#fNote"),
    fPhoto: qs("#fPhoto"),
    fReturnNote: qs("#fReturnNote"),
    btnStart: qs("#btnStart"),
    btnReturn: qs("#btnReturn")
  };

  // Back to main list
  el.btnBack.onclick = () => {
    location.href = location.origin + location.pathname;
  };

  function loadIdentity(){
    try{ const v = JSON.parse(localStorage.getItem("stegra_identity")||"{}");
      el.fName.value = v.name||"";
      el.fPhone.value = v.phone||"";
      el.fCompany.value = v.company||"";
    }catch{}
  }
  function saveIdentity(){
    const v = { name: el.fName.value.trim(), phone: el.fPhone.value.trim(), company: el.fCompany.value.trim() };
    localStorage.setItem("stegra_identity", JSON.stringify(v));
  }
  function setStatusBadge(s){
    el.statusPill.textContent = (s||"available").toUpperCase();
  }
  function dotClass(status){
    return status === 'available' ? 'green' : (status === 'out' ? 'red' : 'gray');
  }

  // -------- LIST VIEW ----------
  async function fetchAllItems(){
    const { data, error } = await sb.from("items").select("*").order("created_at", { ascending: false });
    if(error) throw error;
    return data || [];
  }
  function renderList(items){
    el.list.innerHTML = "";
    if(!items.length){ el.list.innerHTML = '<div class="muted">No items yet.</div>'; return; }
    for (const it of items){
      const row = document.createElement('div');
      row.className = 'li';
      const statusDot = `<span class="dot ${dotClass(it.status)}"></span>`;
      const name = `<a class="itemlink" href="?item=${it.id}"><strong>${it.name}</strong></a>`;
      const renta = `<div class="small muted">Renta ID: ${it.renta_asset_code || '—'}</div>`;
      row.innerHTML = `
        ${statusDot}
        <div>
          ${name}
          ${renta}
        </div>
        <div class="right small muted">${(it.status||'available').toUpperCase()}</div>
      `;
      el.list.appendChild(row);
    }
  }
  async function showList(){
    el.itemPanel.classList.add('hidden');
    el.listPanel.classList.remove('hidden');
    el.msg.textContent = "Loading…";
    try{
      const items = await fetchAllItems();
      renderList(items);
      el.msg.textContent = "";
    }catch(e){
      console.error(e);
      el.msg.textContent = "Could not load items.";
    }
  }

  // -------- ITEM VIEW ----------
  async function fetchItem(id){
    const { data, error } = await sb.from("items").select("*").eq("id", id).single();
    if(error) throw error;
    return data;
  }
  async function getActiveRental(item_id){
    const { data, error } = await sb.from("rentals").select("*").eq("item_id", item_id).is("return_at", null).maybeSingle();
    if(error) throw error;
    return data;
  }
  async function uploadPhoto(file){
    if(!file) return null;
    const key = `${crypto.randomUUID()}-${file.name.replace(/\s+/g,'_')}`;
    const { error } = await sb.storage.from(RETURNS_BUCKET).upload(key, file, { upsert:false });
    if(error){ console.warn(error); return null; }
    const { data: pub } = sb.storage.from(RETURNS_BUCKET).getPublicUrl(key);
    return pub?.publicUrl || null;
  }
  async function startRental(item){
    const user_name = el.fName.value.trim();
    if(!user_name){ el.msg.textContent = "Please enter your name."; return; }
    const payload = {
      item_id: item.id,
      user_name,
      phone: el.fPhone.value.trim() || null,
      company: el.fCompany.value.trim() || null,
      expected_return: el.fExpected.value || null,
      note: el.fNote.value.trim() || null
    };
    const { error } = await sb.from("rentals").insert(payload);
    if(error){ el.msg.textContent = "Could not start rental."; console.error(error); return; }
    saveIdentity();
    await sb.from("items").update({ status:"out" }).eq("id", item.id);
    el.msg.textContent = "Checked out ✔";
    renderItem(item.id);
  }
  async function returnRental(item, rental){
    let photoUrl = null;
    if(el.fPhoto.files && el.fPhoto.files[0]) photoUrl = await uploadPhoto(el.fPhoto.files[0]);
    const note = el.fReturnNote.value.trim() || null;
    const { error } = await sb.from("rentals").update({ return_at: new Date().toISOString(), return_photo_url: photoUrl, note }).eq("id", rental.id);
    if(error){ el.msg.textContent = "Could not complete return."; console.error(error); return; }
    await sb.from("items").update({ status:"available" }).eq("id", item.id);
    el.msg.textContent = "Returned ✔";
    renderItem(item.id);
  }
  async function renderItem(id){
    el.listPanel.classList.add('hidden');
    el.itemPanel.classList.remove('hidden');
    el.msg.textContent = "Loading…";
    try{
      const item = await fetchItem(id);
      setStatusBadge(item.status);
      el.itemName.textContent = item.name;
      el.itemRenta.textContent = item.renta_asset_code || "—";
      loadIdentity();

      const active = await getActiveRental(item.id);
      if(active){
        el.startForm.classList.add("hidden");
        el.returnForm.classList.remove("hidden");
        el.info.textContent = `Checked out by ${active.user_name} since ${new Date(active.start_at).toLocaleString()}`;
        el.btnReturn.onclick = () => returnRental(item, active);
      } else {
        el.returnForm.classList.add("hidden");
        el.startForm.classList.remove("hidden");
        el.info.textContent = "This item is available.";
        el.btnStart.onclick = () => startRental(item);
      }
      el.msg.textContent = "";
    }catch(e){
      console.error(e);
      el.msg.textContent = "Item not found. Check the UUID.";
    }
  }

  // Router
  window.addEventListener("load", ()=> {
    ensureSupabaseReady(()=> {
      if (p.get("item")) renderItem(p.get("item"));
      else showList();
    });
  });
</script>
</body>
</html>
